# ODCR本地管理工具 - 详细使用指南

## 概述
本地Python脚本实现ODCR管理功能，支持**创建新ODCR**和**扩容现有ODCR**两种模式，内置智能拆分购买逻辑和实时进度显示。

## 安装配置

### 1. 安装Python依赖
```bash
pip install -r requirements.txt
```

### 2. 配置AWS凭证
可通过以下方式之一配置：

**方式1: AWS CLI**
```bash
aws configure
```

**方式2: 环境变量**
```bash
export AWS_ACCESS_KEY_ID=your_access_key
export AWS_SECRET_ACCESS_KEY=your_secret_key
export AWS_DEFAULT_REGION=us-west-2
```

**方式3: IAM角色** (在EC2实例上运行时)
无需额外配置，自动使用实例角色

### 3. 所需AWS权限
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ec2:CreateCapacityReservation",
        "ec2:ModifyCapacityReservation", 
        "ec2:DescribeCapacityReservations"
      ],
      "Resource": "*"
    }
  ]
}
```

## 使用方法

### 创建新ODCR
```bash
# 基本用法
python odcr_manager.py create --instance-type INSTANCE_TYPE --availability-zone AZ --count COUNT

# 完整参数示例
python odcr_manager.py create \
  --instance-type r7i.metal-24xl \
  --availability-zone us-west-2a \
  --count 10 \
  --preference open \
  --timeout 60 \
  --region us-west-2
```

### 扩容现有ODCR
```bash
# 基本用法
python odcr_manager.py expand --odcr-id ODCR_ID --count COUNT

# 完整参数示例
python odcr_manager.py expand \
  --odcr-id cr-xxxxxxxxx \
  --count 20 \
  --timeout 60 \
  --region us-west-2
```

### 常用场景

**1. 创建大批量实例预留**
```bash
python odcr_manager.py create --instance-type m5.large --availability-zone us-west-2a --count 50
```

**2. 创建高端实例类型**
```bash
python odcr_manager.py create --instance-type r7i.metal-24xl --availability-zone us-west-2a --count 5
```

**3. 扩容现有ODCR**
```bash
python odcr_manager.py expand --odcr-id cr-abc123def456 --count 10
```

**4. 短时间任务**
```bash
python odcr_manager.py create --instance-type t3.medium --availability-zone us-west-2a --count 20 --timeout 30
```

## 执行示例

### 创建新ODCR - 成功场景 (容量充足)
```
🎯 目标: 创建 8 台 t3.micro 实例在 us-west-2a
⏰ 超时设置: 60 分钟
============================================================

🔄 第1次尝试: 创建新ODCR (8台)
📊 进度: 0/8 (0.0%) | ODCR数量: 0 | 运行时间: 0:00:00
✅ 新ODCR创建成功! cr-abc123 (8 台)
📊 进度: 8/8 (100.0%) | ODCR数量: 1 | 运行时间: 0:00:01
============================================================
🎉 任务完成! 使用 1 个ODCR，总计 8 台实例
📊 总尝试次数: 1
```

### 创建新ODCR - 拆分购买场景 (容量不足)
```
🎯 目标: 创建 10 台 r7i.metal-24xl 实例在 us-west-2a
⏰ 超时设置: 60 分钟
============================================================

🔄 第1次尝试: 创建新ODCR (10台)
📊 进度: 0/10 (0.0%) | ODCR数量: 0 | 运行时间: 0:00:00
⚠️  容量不足，降级到 5 台重试

🔄 第2次尝试: 创建新ODCR (5台)
📊 进度: 0/10 (0.0%) | ODCR数量: 0 | 运行时间: 0:00:05
⚠️  容量不足，降级到 2 台重试

🔄 第3次尝试: 创建新ODCR (2台)
📊 进度: 0/10 (0.0%) | ODCR数量: 0 | 运行时间: 0:00:10
✅ 新ODCR创建成功! cr-def456 (2 台)
📊 进度: 2/10 (20.0%) | ODCR数量: 1 | 运行时间: 0:00:11
⏳ 等待30秒后继续...

🔄 第4次尝试: 扩容ODCR cr-def456 +8台
📊 进度: 2/10 (20.0%) | ODCR数量: 1 | 运行时间: 0:00:41
⚠️  扩容失败，尝试创建新ODCR (8台)
⚠️  容量不足，降级到 4 台重试

🔄 第5次尝试: 创建新ODCR (4台)
📊 进度: 2/10 (20.0%) | ODCR数量: 1 | 运行时间: 0:00:46
✅ 新ODCR创建成功! cr-ghi789 (4 台)
📊 进度: 6/10 (60.0%) | ODCR数量: 2 | 运行时间: 0:00:47
⏳ 等待30秒后继续...

🔄 第6次尝试: 扩容ODCR cr-ghi789 +4台
📊 进度: 6/10 (60.0%) | ODCR数量: 2 | 运行时间: 0:01:17
✅ 扩容成功! ODCR cr-ghi789 现有 8 台
📊 进度: 10/10 (100.0%) | ODCR数量: 2 | 运行时间: 0:01:18
============================================================
🎉 任务完成! 使用 2 个ODCR，总计 10 台实例
📊 总尝试次数: 6

最终结果: ODCR-1(2台) + ODCR-2(8台) = 10台
```

### 扩容现有ODCR - 成功场景
```
🎯 目标: 为ODCR cr-abc123def456 增加 10 台实例
⏰ 超时设置: 60 分钟
============================================================
📊 当前容量: 5 台 (m5.large 在 us-west-2a)

🔄 第1次尝试: 扩容 +10 台
📊 进度: 0/10 (0.0%) | ODCR数量: 0 | 运行时间: 0:00:00
✅ 扩容成功! ODCR cr-abc123def456 现有 15 台 (+10)
📊 进度: 10/10 (100.0%) | ODCR数量: 0 | 运行时间: 0:00:01
============================================================
🎉 扩容完成! ODCR cr-abc123def456 成功增加 10 台，总容量: 15
📊 总尝试次数: 1
```

### 扩容现有ODCR - 拆分购买场景
```
🎯 目标: 为ODCR cr-xyz789abc123 增加 20 台实例
⏰ 超时设置: 60 分钟
============================================================
📊 当前容量: 10 台 (c5.xlarge 在 us-west-2b)

🔄 第1次尝试: 扩容 +20 台
📊 进度: 0/20 (0.0%) | ODCR数量: 0 | 运行时间: 0:00:00
⚠️  容量不足，降级到 +10 台重试

🔄 第2次尝试: 扩容 +10 台
📊 进度: 0/20 (0.0%) | ODCR数量: 0 | 运行时间: 0:00:05
✅ 扩容成功! ODCR cr-xyz789abc123 现有 20 台 (+10)
📊 进度: 10/20 (50.0%) | ODCR数量: 0 | 运行时间: 0:00:06
⏳ 等待30秒后继续扩容剩余 10 台...

🔄 第3次尝试: 扩容 +10 台
📊 进度: 10/20 (50.0%) | ODCR数量: 0 | 运行时间: 0:00:36
✅ 扩容成功! ODCR cr-xyz789abc123 现有 30 台 (+10)
📊 进度: 20/20 (100.0%) | ODCR数量: 0 | 运行时间: 0:00:37
============================================================
🎉 扩容完成! ODCR cr-xyz789abc123 成功增加 20 台，总容量: 30
📊 总尝试次数: 3
```

## 实时功能说明

### 📊 实时状态栏
- **进度百分比**: 当前完成度
- **ODCR数量**: 已创建的ODCR个数
- **运行时间**: 从开始到现在的时间

### ⏱️ 定期状态报告 (每30秒)
```
⏱️  运行状态更新 (0:02:30):
   📈 当前进度: 6/10 台
   🔄 总尝试次数: 5
   📋 ODCR列表: 2
      1. cr-def456 (2台)
      2. cr-ghi789 (4台)
```

### ⏳ 倒计时显示
- **成功后等待**: 30秒倒计时
- **容量不足等待**: 30秒倒计时
- **实时更新**: 显示剩余等待时间

### ⚠️ 中断处理
- **Ctrl+C**: 优雅中断执行
- **状态保存**: 显示当前进度
- **清理退出**: 不会留下未完成的操作

## 输出格式

### 创建新ODCR结果JSON
```json
{
  "success": true,
  "target_count": 10,
  "actual_count": 10,
  "created_odcrs": [
    {
      "odcr_id": "cr-def456",
      "initial_capacity": 2,
      "current_capacity": 2,
      "created_at": "20250923180000"
    },
    {
      "odcr_id": "cr-ghi789",
      "initial_capacity": 4,
      "current_capacity": 8,
      "created_at": "20250923180100"
    }
  ],
  "total_attempts": 6,
  "elapsed_time": "0:01:18",
  "completed": true
}
```

### 扩容ODCR结果JSON
```json
{
  "success": true,
  "odcr_id": "cr-abc123def456",
  "initial_capacity": 5,
  "target_increase": 10,
  "actual_increase": 10,
  "final_capacity": 15,
  "total_attempts": 1,
  "elapsed_time": "0:00:01",
  "completed": true
}
```

### 字段说明

#### 创建新ODCR
- `success`: 是否有任何成功购买
- `target_count`: 目标实例数量
- `actual_count`: 实际获得的实例数量
- `created_odcrs`: 创建的ODCR列表
- `total_attempts`: 总尝试次数
- `elapsed_time`: 总执行时间
- `completed`: 是否完全达到目标

#### 扩容现有ODCR
- `success`: 是否有任何成功扩容
- `odcr_id`: 扩容的ODCR ID
- `initial_capacity`: 扩容前的容量
- `target_increase`: 目标增加数量
- `actual_increase`: 实际增加数量
- `final_capacity`: 扩容后的总容量
- `total_attempts`: 总尝试次数
- `elapsed_time`: 总执行时间
- `completed`: 是否完全达到目标
- `created_odcrs`: 创建的ODCR列表
- `total_attempts`: 总尝试次数
- `elapsed_time`: 总执行时间
- `completed`: 是否完全达到目标

## 核心算法

### 创建新ODCR模式
1. **首次购买**: 创建新ODCR
2. **后续购买**: 优先扩容最后一个ODCR
3. **扩容失败**: 尝试创建新ODCR
4. **目标**: 最小化ODCR数量，最大化资源利用

### 扩容现有ODCR模式
1. **获取当前状态**: 查询ODCR当前容量和配置
2. **计算目标容量**: 当前容量 + 增加数量
3. **尝试扩容**: 调用ModifyCapacityReservation API
4. **拆分重试**: 容量不足时自动减半重试

### 拆分购买策略 (两种模式通用)
1. **初始尝试**: 目标数量
2. **容量不足**: 自动减半 (20→10→5→2→1)
3. **最小单位**: 1台实例
4. **持续重试**: 直到成功或超时

### 等待策略
- **成功后等待**: 30秒 (给AWS时间释放/分配容量)
- **容量不足等待**: 30秒 (等待容量释放)
- **快速重试**: 5秒 (降级重试)

## 故障排除

### 常见问题

**1. 权限错误**
```
错误: AccessDenied
解决: 检查AWS凭证和IAM权限
```

**2. 区域错误**
```
错误: InvalidAvailabilityZone
解决: 确认可用区在指定区域内存在
```

**3. 实例类型错误**
```
错误: InvalidInstanceType
解决: 确认实例类型在指定区域可用
```

**4. ODCR不存在 (扩容模式)**
```
错误: ODCR not found
解决: 确认ODCR ID正确且在指定区域
```

**5. 完全无容量**
```
现象: 即使1台也无法获得容量
解决: 尝试其他可用区或实例类型
```

### 调试技巧

**1. 使用较小的超时时间测试**
```bash
# 创建模式测试
python odcr_manager.py create --instance-type t3.micro --availability-zone us-west-2a --count 2 --timeout 5

# 扩容模式测试 (需要真实ODCR ID)
python odcr_manager.py expand --odcr-id cr-xxxxxxxxx --count 2 --timeout 5
```

**2. 检查AWS凭证**
```bash
aws sts get-caller-identity
```

**3. 验证区域和可用区**
```bash
aws ec2 describe-availability-zones --region us-west-2
```

**4. 查看现有ODCR**
```bash
aws ec2 describe-capacity-reservations --region us-west-2
```

## 最佳实践

### 1. 容量规划
- 在高峰时段前提前预留
- 考虑使用多个可用区分散风险
- 监控容量使用情况
- 优先扩容现有ODCR而非创建新的

### 2. 成本优化
- 使用合适的实例类型
- 及时释放不需要的ODCR
- 考虑使用Savings Plans
- 通过扩容减少ODCR数量

### 3. 运维建议
- 定期检查ODCR状态
- 监控容量利用率
- 建立容量预警机制
- 记录ODCR ID用于后续扩容

## 高级用法

### 1. 批量脚本
```bash
#!/bin/bash
# 批量创建不同类型的ODCR

python odcr_manager.py create --instance-type m5.large --availability-zone us-west-2a --count 10
python odcr_manager.py create --instance-type c5.xlarge --availability-zone us-west-2b --count 5
python odcr_manager.py create --instance-type r5.large --availability-zone us-west-2c --count 8

# 批量扩容现有ODCR
python odcr_manager.py expand --odcr-id cr-abc123 --count 5
python odcr_manager.py expand --odcr-id cr-def456 --count 10
```

### 2. 结果处理
```bash
# 保存创建结果到文件
python odcr_manager.py create --instance-type m5.large --availability-zone us-west-2a --count 10 > create_result.log 2>&1

# 保存扩容结果到文件
python odcr_manager.py expand --odcr-id cr-xxxxxxxxx --count 10 > expand_result.log 2>&1

# 提取ODCR ID
python odcr_manager.py create --instance-type m5.large --availability-zone us-west-2a --count 10 | grep "cr-" | awk '{print $4}'
```

### 3. 监控集成
```python
# 示例: 集成到监控系统
import subprocess
import json

# 创建新ODCR
result = subprocess.run(['python', 'odcr_manager.py', 'create', '--instance-type', 'm5.large', '--availability-zone', 'us-west-2a', '--count', '10'], 
                       capture_output=True, text=True)

# 扩容现有ODCR
result = subprocess.run(['python', 'odcr_manager.py', 'expand', '--odcr-id', 'cr-xxxxxxxxx', '--count', '5'], 
                       capture_output=True, text=True)

if result.returncode == 0:
    # 解析JSON结果并发送到监控系统
    output_lines = result.stdout.strip().split('\n')
    json_result = json.loads(output_lines[-1])
    # 发送到监控系统...
```
```

### 2. 结果处理
```bash
# 保存结果到文件
python odcr_manager.py create --instance-type m5.large --availability-zone us-west-2a --count 10 > result.log 2>&1

# 提取ODCR ID
python odcr_manager.py create --instance-type m5.large --availability-zone us-west-2a --count 10 | grep "cr-" | awk '{print $4}'
```

### 3. 监控集成
```python
# 示例: 集成到监控系统
import subprocess
import json

result = subprocess.run(['python', 'odcr_manager.py', 'create', '--instance-type', 'm5.large', '--availability-zone', 'us-west-2a', '--count', '10'], 
                       capture_output=True, text=True)

if result.returncode == 0:
    # 解析JSON结果并发送到监控系统
    output_lines = result.stdout.strip().split('\n')
    json_result = json.loads(output_lines[-1])
    # 发送到监控系统...
```
